<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EhkoForge</title>
    
    <link rel="stylesheet" href="/css/main.css">
    <link rel="stylesheet" href="/css/recog.css">
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600&family=VT323&display=swap" rel="stylesheet">
</head>
<body>
    <!-- CRT Overlay Effect -->
    <div class="crt-overlay"></div>
    
    <!-- Main Container -->
    <div class="terminal-container">
        
        <!-- Header Bar -->
        <header class="header-bar">
            <!-- Brand -->
            <div class="header-brand">
                <div class="brand-logo">
                    <span class="brand-icon">‚öí</span>
                </div>
                <div class="brand-text">
                    <span class="brand-name">EHKOFORGE</span>
                    <span class="brand-version">v2.0</span>
                </div>
            </div>
            
            <!-- Mode Dial - Retro Toggle -->
            <div class="mode-dial-container">
                <div class="dial-track">
                    <span class="dial-label dial-label-terminal" data-mode="terminal">TERMINAL</span>
                    <div class="dial-channel">
                        <div class="dial-knob" id="dial-knob">
                            <div class="knob-grip"></div>
                            <div class="knob-grip"></div>
                            <div class="knob-grip"></div>
                        </div>
                    </div>
                    <span class="dial-label dial-label-reflect" data-mode="reflection">REFLECT</span>
                </div>
                <div class="dial-indicators">
                    <span class="dial-led active" id="led-terminal"></span>
                    <span class="dial-led" id="led-reflect"></span>
                </div>
            </div>
            
            <!-- Model Selector -->
            <div class="model-selector">
                <div class="model-dropdown" id="model-dropdown">
                    <button class="model-dropdown-trigger" id="model-trigger">
                        <span class="model-name" id="selected-model-name">Claude Sonnet 4</span>
                        <span class="model-trigger-cost" id="selected-model-cost">‚óÜ1</span>
                        <span class="dropdown-arrow">‚ñæ</span>
                    </button>
                    <div class="model-dropdown-menu" id="model-menu">
                        <div class="model-option" data-model="claude-sonnet-4" data-cost-terminal="1" data-cost-reflection="3">
                            <span class="option-name">Claude Sonnet 4</span>
                            <span class="option-cost"></span>
                        </div>
                        <div class="model-option" data-model="claude-opus-4" data-cost-terminal="2" data-cost-reflection="6">
                            <span class="option-name">Claude Opus 4</span>
                            <span class="option-cost"></span>
                        </div>
                        <div class="model-option" data-model="claude-haiku-4" data-cost-terminal="0.5" data-cost-reflection="1.5">
                            <span class="option-name">Claude Haiku 4</span>
                            <span class="option-cost"></span>
                        </div>
                        <div class="model-option" data-model="gpt-4o" data-cost-terminal="1.5" data-cost-reflection="4">
                            <span class="option-name">GPT-4o</span>
                            <span class="option-cost"></span>
                        </div>
                        <div class="model-option" data-model="gpt-4o-mini" data-cost-terminal="0.3" data-cost-reflection="1">
                            <span class="option-name">GPT-4o mini</span>
                            <span class="option-cost"></span>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="header-right">
                <button class="recog-link" id="recog-btn" title="ReCog Engine">
                    <span class="recog-icon">‚öô</span>
                    <span class="recog-label">ReCog</span>
                    <span class="recog-badge" id="recog-badge" style="display: none;">0</span>
                </button>
                <a href="/forge" class="forge-link" title="Review Insites">
                    <span class="forge-icon">‚ö°</span>
                    <span class="forge-label">Forge</span>
                    <span class="insite-badge" id="insite-badge" style="display: none;">0</span>
                </a>
                <button class="settings-btn" id="settings-btn" title="Settings">‚öô</button>
            </div>
        </header>
        
        <!-- Status Bar (Authority + ASCII Logo + Mana) -->
        <div class="status-bar">
            <!-- Authority Progress -->
            <div class="authority-section">
                <div class="authority-header">
                    <span class="authority-label">AUTHORITY</span>
                    <span class="authority-value" id="authority-total">0%</span>
                    <span class="authority-stage" id="authority-stage">Nascent</span>
                </div>
                <div class="authority-bars">
                    <div class="authority-bar" data-component="memory_depth" title="Memory Depth">
                        <div class="bar-fill" style="width: 0%"></div>
                        <span class="bar-label">MEM</span>
                    </div>
                    <div class="authority-bar" data-component="identity_clarity" title="Identity Clarity">
                        <div class="bar-fill" style="width: 0%"></div>
                        <span class="bar-label">IDN</span>
                    </div>
                    <div class="authority-bar" data-component="emotional_range" title="Emotional Range">
                        <div class="bar-fill" style="width: 0%"></div>
                        <span class="bar-label">EMO</span>
                    </div>
                    <div class="authority-bar" data-component="temporal_coverage" title="Temporal Coverage">
                        <div class="bar-fill" style="width: 0%"></div>
                        <span class="bar-label">TMP</span>
                    </div>
                    <div class="authority-bar" data-component="core_density" title="Core Density">
                        <div class="bar-fill" style="width: 0%"></div>
                        <span class="bar-label">COR</span>
                    </div>
                </div>
            </div>
            
            <!-- ASCII EHKO Logo (center) -->
            <div class="ascii-logo-section" id="ascii-section">
                <pre class="ascii-logo" id="ascii-display"></pre>
            </div>
            
            <!-- Mana Display -->
            <div class="mana-section">
                <ehko-mana-bar 
                    id="mana-bar"
                    current="100" 
                    regen="100" 
                    purchased="0"
                    show-breakdown="true">
                </ehko-mana-bar>
                
                <!-- LLM Tether System (Web Components) -->
                <div class="tethers-section" id="tethers-section">
                    <div class="tethers-header">
                        <span class="tethers-label">TETHERS</span>
                        <button class="tethers-manage-btn" id="tethers-manage-btn" title="Manage Tethers">‚öô</button>
                    </div>
                    <div class="tethers-list" id="tethers-list">
                        <!-- Populated by JS with <ehko-tether-bar> components -->
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Avatar Zone -->
        <div class="avatar-zone" id="avatar-zone">
            <!-- Terminal header -->
            <div class="terminal-header">
                <span class="terminal-label">‚óÜ EHKO DISPLAY</span>
                <span class="terminal-version">v2.0</span>
            </div>
            
            <!-- Monitor screen wrapper -->
            <div class="monitor-screen">
                <!-- Full-width matrix code background -->
                <canvas class="matrix-code-bg" id="matrix-canvas" width="1200" height="120"></canvas>
            
                <!-- Ehko Avatar Web Component -->
                <ehko-avatar 
                    id="ehko-avatar"
                    stage="nascent"
                    mood="ready"
                    name="Ehko"
                    size="100">
                </ehko-avatar>
            </div>
        </div>
        
        <!-- Terminal Output -->
        <div class="terminal-output" id="terminal-output">
            <div class="welcome-message">
                <p class="welcome-text" id="welcome-text">
                    > TERMINAL MODE ‚Äî Your Ehko awaits.
                </p>
            </div>
        </div>
        
        <!-- Input Bar -->
        <div class="input-bar">
            <span class="input-prompt" id="input-prompt">&gt;</span>
            <textarea 
                id="message-input" 
                placeholder="Type a message..."
                rows="1"
            ></textarea>
            <div class="input-cost" id="input-cost" title="Mana cost">
                <span class="cost-icon">‚óÜ</span>
                <span class="cost-value">1</span>
            </div>
            <button class="send-btn" id="send-btn" title="Send (Enter)">‚Üµ</button>
        </div>
        
        <!-- Session Controls -->
        <div class="session-bar">
            <div class="session-info">
                <span class="session-label">Session:</span>
                <span class="session-title" id="session-title">New Chat</span>
            </div>
            <div class="session-actions">
                <button class="session-btn" id="new-session-btn" title="New Session">+</button>
                <button class="session-btn" id="forge-session-btn" title="Forge to Vault">‚ö°</button>
                <button class="session-btn" id="history-btn" title="Session History">‚ò∞</button>
            </div>
        </div>
    </div>
    
    <!-- Session History Drawer -->
    <div class="drawer-overlay" id="history-overlay">
        <div class="drawer history-drawer">
            <div class="drawer-header">
                <h2>Session History</h2>
                <button class="drawer-close" id="history-close">√ó</button>
            </div>
            <div class="drawer-content" id="session-list">
                <!-- Populated by JS -->
            </div>
        </div>
    </div>
    
    <!-- Settings Drawer -->
    <div class="drawer-overlay" id="settings-overlay">
        <div class="drawer settings-drawer">
            <div class="drawer-header">
                <h2>Settings</h2>
                <button class="drawer-close" id="settings-close">√ó</button>
            </div>
            <div class="drawer-content">
                <!-- LLM Tethers -->
                <div class="setting-group">
                    <label class="setting-label">LLM Tethers</label>
                    <p class="setting-description">Connect your own API keys to bypass mana consumption. Tethers provide unlimited access to LLM providers.</p>
                    <button class="setting-action" id="open-tether-panel">‚ö° Manage Tethers</button>
                </div>
                
                <!-- Display Settings -->
                <div class="setting-group">
                    <label class="setting-label">Display</label>
                    <div class="setting-item">
                        <input type="checkbox" id="setting-avatar" checked>
                        <label for="setting-avatar">Show Avatar Zone</label>
                    </div>
                    <div class="setting-item">
                        <input type="checkbox" id="setting-scanlines" checked>
                        <label for="setting-scanlines">CRT Scanline Effect</label>
                    </div>
                    <div class="setting-item">
                        <input type="checkbox" id="setting-motion">
                        <label for="setting-motion">Reduce Motion</label>
                    </div>
                    <div class="setting-item">
                        <input type="checkbox" id="setting-ascii-logo" checked>
                        <label for="setting-ascii-logo">Show ASCII Logo</label>
                    </div>
                </div>
                
                <!-- Data & Privacy -->
                <div class="setting-group">
                    <label class="setting-label">Data & Privacy</label>
                    <p class="setting-description">Your data is stored locally. API keys are encrypted and never leave your device.</p>
                    <button class="setting-action setting-secondary" id="export-data">Export My Data</button>
                    <button class="setting-action setting-danger" id="clear-all-data">Clear All Local Data</button>
                </div>
                
                <!-- Debug -->
                <div class="setting-group">
                    <label class="setting-label">Debug</label>
                    <button class="setting-action" id="refresh-authority">Recalculate Authority</button>
                    <button class="setting-action" id="refresh-tethers">Refresh Tether Status</button>
                    <button class="setting-action" id="view-usage-history">View Usage History</button>
                </div>
                
                <!-- About -->
                <div class="setting-group">
                    <label class="setting-label">About</label>
                    <div class="about-info">
                        <p><strong>EhkoForge</strong> v2.0</p>
                        <p class="about-tagline">Digital identity preservation system</p>
                        <p class="about-links">
                            <a href="https://ehkoforge.ai" target="_blank">Website</a> ¬∑ 
                            <a href="https://github.com/ehkoforge" target="_blank">GitHub</a> ¬∑ 
                            <a href="mailto:support@ehkoforge.ai">Support</a>
                        </p>
                        <p class="about-license">Licensed under AGPLv3</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Forge Modal -->
    <div class="modal-overlay" id="forge-overlay">
        <div class="modal forge-modal">
            <div class="modal-header">
                <h2>Forge to Vault</h2>
                <button class="modal-close" id="forge-close">√ó</button>
            </div>
            <div class="modal-content">
                <div class="forge-field">
                    <label for="forge-title">Title</label>
                    <input type="text" id="forge-title" placeholder="Reflection title...">
                </div>
                <div class="forge-field">
                    <label for="forge-tags">Tags (comma-separated)</label>
                    <input type="text" id="forge-tags" placeholder="identity, values, growth...">
                </div>
                <div class="forge-field">
                    <label for="forge-emotional">Emotional Tags</label>
                    <input type="text" id="forge-emotional" placeholder="hopeful, anxious, curious...">
                </div>
                <div class="forge-preview">
                    <span class="preview-count" id="forge-count">0 messages selected</span>
                </div>
            </div>
            <div class="modal-actions">
                <button class="modal-cancel" id="forge-cancel">Cancel</button>
                <button class="modal-confirm" id="forge-confirm">Forge</button>
            </div>
        </div>
    </div>
    
    <!-- Dormant Modal -->
    <div class="modal-overlay" id="dormant-overlay">
        <div class="modal dormant-modal">
            <div class="modal-header">
                <h2>Ehko is Resting</h2>
            </div>
            <div class="modal-content">
                <div class="dormant-icon">‚óá</div>
                <p class="dormant-message" id="dormant-message">
                    My mana has been depleted. I need time to recover.
                </p>
                <div class="dormant-stats">
                    <span>Current: <strong id="dormant-current">0</strong></span>
                    <span>Required: <strong id="dormant-required">1</strong></span>
                </div>
            </div>
            <div class="modal-actions">
                <button class="modal-confirm" id="dormant-ok">Understood</button>
            </div>
        </div>
    </div>

    <!-- Mana Purchase Modal -->
    <div class="modal-overlay" id="purchase-overlay">
        <div class="modal purchase-modal">
            <div class="modal-header">
                <h2>Purchase Mana-Cores</h2>
                <button class="modal-close" id="purchase-close">√ó</button>
            </div>
            <div class="modal-content">
                <p class="purchase-info">Top up your mana to continue reflecting and journaling. No subscriptions, no expiry.</p>
                <div class="pricing-tiers" id="pricing-tiers">
                    <!-- Populated by JS -->
                </div>
                <div class="purchase-note">
                    <p><strong>Note:</strong> This is a simulated purchase for MVP testing. Actual Stripe integration coming Q1 2026.</p>
                    <p>Questions? Contact <a href="mailto:licensing@ehkoforge.ai">licensing@ehkoforge.ai</a></p>
                </div>
            </div>
        </div>
    </div>

    <!-- Usage History Modal -->
    <div class="modal-overlay" id="usage-overlay">
        <div class="modal usage-modal">
            <div class="modal-header">
                <h2>Mana Usage History</h2>
                <button class="modal-close" id="usage-close">√ó</button>
            </div>
            <div class="modal-content">
                <div class="usage-tabs">
                    <button class="usage-tab active" data-tab="purchases">Purchases</button>
                    <button class="usage-tab" data-tab="usage">Usage Stats</button>
                </div>
                <div class="usage-tab-content">
                    <div class="usage-pane active" id="purchases-pane">
                        <div class="purchase-history" id="purchase-history">
                            <!-- Populated by JS -->
                        </div>
                    </div>
                    <div class="usage-pane" id="usage-pane">
                        <div class="usage-stats" id="usage-stats">
                            <!-- Populated by JS -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ReCog Drawer -->
    <div class="drawer-overlay" id="recog-overlay">
        <div class="drawer recog-drawer">
            <div class="drawer-header">
                <h2>ReCog Engine</h2>
                <button class="drawer-close" id="recog-close">√ó</button>
            </div>
            
            <!-- Tabs -->
            <div class="recog-tabs">
                <button class="recog-tab active" data-tab="queue">Queue</button>
                <button class="recog-tab" data-tab="insights">Insights</button>
                <button class="recog-tab" data-tab="preflight">Preflight</button>
                <button class="recog-tab" data-tab="reports">Reports</button>
                <button class="recog-tab" data-tab="progression">Progression</button>
            </div>
            
            <!-- Queue Pane -->
            <div class="recog-pane active" id="recog-pane-queue">
                <!-- Status Card -->
                <div class="recog-status-card">
                    <div class="recog-status-header">
                        <span class="recog-status-title">Engine Status</span>
                        <div class="recog-status-indicator">
                            <span class="recog-status-dot" id="recog-status-dot"></span>
                            <span id="recog-status-text">Checking...</span>
                        </div>
                    </div>
                    <div class="recog-stats">
                        <div class="recog-stat">
                            <div class="recog-stat-value" id="stat-hot">0</div>
                            <div class="recog-stat-label">Hot Sessions</div>
                        </div>
                        <div class="recog-stat">
                            <div class="recog-stat-value" id="stat-insights">0</div>
                            <div class="recog-stat-label">Pending Insights</div>
                        </div>
                        <div class="recog-stat">
                            <div class="recog-stat-value" id="stat-patterns">0</div>
                            <div class="recog-stat-label">Patterns</div>
                        </div>
                    </div>
                </div>
                
                <!-- Pending Operations -->
                <div class="pending-operations">
                    <div class="pending-header">
                        <span class="pending-title">Pending Operations</span>
                        <button class="pending-check-btn" id="recog-check-btn">Check Now</button>
                    </div>
                    <div class="pending-list" id="pending-list">
                        <!-- Populated by JS -->
                    </div>
                </div>
            </div>
            
            <!-- Insights Pane -->
            <div class="recog-pane" id="recog-pane-insights">
                <!-- Search and Filter -->
                <div class="insights-toolbar">
                    <input type="text" class="insights-search" id="insights-search" placeholder="Search insights...">
                    <select class="insights-filter" id="insights-filter">
                        <option value="all">All Insights</option>
                        <option value="flagged">‚òÖ Flagged</option>
                        <option value="unreviewed">Unreviewed</option>
                        <option value="rejected">Rejected</option>
                    </select>
                </div>
                
                <!-- Insights List -->
                <div class="insights-list-container">
                    <div class="insights-list" id="insights-list">
                        <!-- Populated by JS -->
                    </div>
                    <button class="insights-load-more" id="insights-load-more" style="display: none;">Load More</button>
                </div>
                
                <!-- Insight Detail Panel (slides in) -->
                <div class="insights-detail" id="insights-detail">
                    <!-- Populated by JS -->
                </div>
            </div>
            
            <!-- Preflight Pane -->
            <div class="recog-pane" id="recog-pane-preflight">
                <!-- Upload Section -->
                <div class="preflight-upload-section">
                    <div class="preflight-upload-header">
                        <span class="preflight-title">Import Content</span>
                        <span class="preflight-subtitle">FREE Tier 0 scan</span>
                    </div>
                    <div class="preflight-drop-zone" id="preflight-drop-zone">
                        <div class="drop-zone-icon">üìÅ</div>
                        <div class="drop-zone-text">Drop files here or click to browse</div>
                        <div class="drop-zone-formats">ChatGPT export (.json), Text files</div>
                        <input type="file" id="preflight-file-input" accept=".json,.txt,.md" multiple hidden>
                    </div>
                </div>
                
                <!-- Active Session -->
                <div class="preflight-session" id="preflight-session" style="display: none;">
                    <div class="preflight-session-header">
                        <span class="session-type" id="preflight-session-type">ChatGPT Import</span>
                        <span class="session-status" id="preflight-session-status">Scanning...</span>
                    </div>
                    
                    <!-- Scan Progress -->
                    <div class="preflight-progress" id="preflight-progress">
                        <div class="progress-bar">
                            <div class="progress-fill" id="preflight-progress-fill"></div>
                        </div>
                        <div class="progress-text" id="preflight-progress-text">Processing...</div>
                    </div>
                    
                    <!-- Summary Stats -->
                    <div class="preflight-summary" id="preflight-summary" style="display: none;">
                        <div class="summary-stats">
                            <div class="summary-stat">
                                <div class="summary-value" id="pf-item-count">0</div>
                                <div class="summary-label">Items</div>
                            </div>
                            <div class="summary-stat">
                                <div class="summary-value" id="pf-word-count">0</div>
                                <div class="summary-label">Words</div>
                            </div>
                            <div class="summary-stat">
                                <div class="summary-value" id="pf-entity-count">0</div>
                                <div class="summary-label">Entities</div>
                            </div>
                            <div class="summary-stat cost">
                                <div class="summary-value">$<span id="pf-cost-estimate">0.00</span></div>
                                <div class="summary-label">Est. Cost</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Entity Questions -->
                    <div class="preflight-entities" id="preflight-entities" style="display: none;">
                        <div class="entities-header">
                            <span class="entities-title">Unknown Contacts</span>
                            <span class="entities-count" id="pf-unknown-count">0 need identification</span>
                        </div>
                        <div class="entities-list" id="preflight-entities-list">
                            <!-- Populated by JS -->
                        </div>
                    </div>
                    
                    <!-- Filters -->
                    <div class="preflight-filters" id="preflight-filters" style="display: none;">
                        <div class="filters-header">
                            <span class="filters-title">Filters</span>
                            <button class="filters-toggle" id="pf-filters-toggle">‚ñº</button>
                        </div>
                        <div class="filters-content" id="pf-filters-content" style="display: none;">
                            <div class="filter-row">
                                <label>Min words:</label>
                                <input type="number" id="pf-filter-min-words" value="50" min="0">
                            </div>
                            <div class="filter-row">
                                <label>Date after:</label>
                                <input type="date" id="pf-filter-date-after">
                            </div>
                            <div class="filter-row">
                                <label>Keywords:</label>
                                <input type="text" id="pf-filter-keywords" placeholder="comma,separated">
                            </div>
                            <button class="filter-apply-btn" id="pf-filter-apply">Apply Filters</button>
                        </div>
                    </div>
                    
                    <!-- Actions -->
                    <div class="preflight-actions">
                        <button class="preflight-btn secondary" id="pf-cancel-btn">Cancel</button>
                        <button class="preflight-btn primary" id="pf-confirm-btn" disabled>
                            <span>Confirm & Process</span>
                            <span class="btn-cost">‚óÜ<span id="pf-mana-cost">0</span></span>
                        </button>
                    </div>
                </div>
                
                <!-- Empty State -->
                <div class="preflight-empty" id="preflight-empty">
                    <div class="empty-icon">üì•</div>
                    <div class="empty-text">No active import</div>
                    <div class="empty-hint">Upload a ChatGPT export or other content to scan</div>
                </div>
            </div>
            
            <!-- Reports Pane -->
            <div class="recog-pane" id="recog-pane-reports">
                <div class="reports-list" id="reports-list">
                    <!-- Populated by JS -->
                </div>
                <!-- Report Detail Panel (slides in) -->
                <div class="report-detail" id="report-detail">
                    <!-- Populated by JS -->
                </div>
            </div>
            
            <!-- Progression Pane -->
            <div class="recog-pane" id="recog-pane-progression">
                <div class="progression-card">
                    <div class="progression-stage" id="progression-stage">Nascent</div>
                    <div class="progression-entered" id="progression-entered"></div>
                    
                    <div class="progression-pillars" id="pillars-list">
                        <!-- Populated by JS -->
                    </div>
                    
                    <div class="progression-stats">
                        <div class="progression-stat">
                            <div class="progression-stat-value" id="core-memory-count">0</div>
                            <div class="progression-stat-label">Core Memories</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Process Button -->
            <div class="process-section">
                <button class="process-btn" id="recog-process-btn" disabled>
                    <span>‚ñ∂</span>
                    <span>Process Confirmed (<span id="confirmed-count">0</span>)</span>
                </button>
            </div>
        </div>
    </div>

    <!-- ReCog Processing Overlay -->
    <div class="processing-overlay" id="processing-overlay">
        <div class="processing-animation">
            <div class="processing-ring"></div>
            <div class="processing-ring"></div>
            <div class="processing-ring"></div>
            <div class="processing-core"></div>
        </div>
        <div class="processing-text" id="processing-text">Processing...</div>
        <div class="processing-subtext" id="processing-subtext"></div>
    </div>

    <!-- ReCog Toast -->
    <div class="recog-toast" id="recog-toast"></div>

    <!-- Tether Management Panel (Web Component) -->
    <ehko-tether-panel id="tether-panel"></ehko-tether-panel>

    <script src="/js/main.js"></script>
    <script src="/js/recog.js"></script>
    <script src="/js/preflight.js"></script>
    <script src="/components/ehko-toast.js"></script>
    <script src="/components/ehko-mana-bar.js"></script>
    <script src="/components/ehko-tether-bar.js"></script>
    <script src="/components/ehko-tether-panel.js"></script>
    <script src="/components/ehko-avatar.js"></script>
    <script src="/components/ehko-message.js"></script>
</body>
</html>
